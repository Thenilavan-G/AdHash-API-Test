name: AdHash Daily API Tests

on:
  schedule:
    # Runs EVERY DAY at 9:00 AM IST (3:30 AM UTC)
    - cron: '30 3 * * *'
    # Runs EVERY DAY at 5:00 PM IST (11:30 AM UTC)
    - cron: '30 11 * * *'
  workflow_dispatch:
    # Allows manual triggering of the workflow

jobs:
  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Max 15 minutes to prevent hanging (tests normally complete in ~2 mins)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Display current IST time
      run: |
        echo "Current UTC time: $(date -u)"
        echo "Current IST time: $(TZ='Asia/Kolkata' date)"
        echo "Workflow triggered for AdHash API tests (Weekends & Holidays 2026)"
        
    - name: Run AdHash API Tests
      run: |
        echo "Starting AdHash Daily API Tests..."
        echo "Running all 73 API tests for AdHash projects"
        mvn test -Dsurefire.suiteXmlFiles=TestNG.xml -DfailIfNoTests=false
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: adhash-api-test-results
        path: |
          target/surefire-reports/
          target/test-classes/
        retention-days: 30
        
    - name: Display test summary
      if: always()
      run: |
        echo "=== AdHash API Tests Summary ==="
        echo "Date: $(TZ='Asia/Kolkata' date '+%d/%m/%Y %H:%M IST')"
        echo "Repository: AdHash-API-Test"
        echo "Test Suite: TestNG.xml"
        echo "Expected Tests: 73 (All AdHash Projects API Tests)"
        echo "Test Class: generated.GeneratedApiTest"
        echo "============================================="
        
    - name: Parse test results
      if: always()
      id: test-results
      run: |
        # Initialize variables
        TESTS_RUN=0
        FAILURES=0
        ERRORS=0
        SKIPPED=0
        STATUS="UNKNOWN"

        # Parse TestNG results if available
        if [ -f target/surefire-reports/testng-results.xml ]; then
          echo "Parsing TestNG results..."
          TESTS_RUN=$(grep -o 'total="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
          FAILURES=$(grep -o 'failed="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
          ERRORS=$(grep -o 'errors="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
          SKIPPED=$(grep -o 'skipped="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
        fi

        # Determine overall status
        if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ] && [ "$TESTS_RUN" -gt 0 ]; then
          STATUS="SUCCESS"
        elif [ "$TESTS_RUN" -eq 0 ]; then
          STATUS="NO_TESTS"
        else
          STATUS="FAILURE"
        fi

        # Set outputs for email step
        echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
        echo "failures=$FAILURES" >> $GITHUB_OUTPUT
        echo "errors=$ERRORS" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "timestamp=$(TZ='Asia/Kolkata' date '+%d/%m/%Y %H:%M IST')" >> $GITHUB_OUTPUT

        echo "Test Results Summary:"
        echo "Tests Run: $TESTS_RUN"
        echo "Failures: $FAILURES"
        echo "Errors: $ERRORS"
        echo "Skipped: $SKIPPED"
        echo "Status: $STATUS"

    - name: Calculate Test Statistics
      if: always()
      id: test-stats
      shell: bash
      run: |
        TESTS_RUN="${{ steps.test-results.outputs.tests_run }}"
        FAILURES="${{ steps.test-results.outputs.failures }}"
        ERRORS="${{ steps.test-results.outputs.errors }}"

        # Calculate passed tests
        PASSED=$((TESTS_RUN - FAILURES - ERRORS))
        FAILED=$((FAILURES + ERRORS))

        # Calculate success rate
        if [ "$TESTS_RUN" -gt 0 ]; then
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED * 100.0 / $TESTS_RUN)}")
        else
          SUCCESS_RATE="0.0"
        fi

        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT

        echo "Calculated Statistics:"
        echo "Passed: $PASSED"
        echo "Failed: $FAILED"
        echo "Success Rate: $SUCCESS_RATE%"

    - name: Extract Individual Test Results
      if: always()
      id: extract-tests
      shell: bash
      run: |
        echo "Extracting individual test results..."

        # Create a temporary file for test details
        TEST_DETAILS_FILE="test_details.html"

        if [ -f target/surefire-reports/testng-results.xml ]; then
          # Parse TestNG XML and extract test methods
          python3 << 'EOF'
        import xml.etree.ElementTree as ET
        import html

        try:
            tree = ET.parse('target/surefire-reports/testng-results.xml')
            root = tree.getroot()

            test_rows = []
            test_count = 0

            # Find all test methods
            for test_method in root.findall('.//test-method[@is-config="false"]'):
                test_count += 1
                name = test_method.get('name', 'Unknown')
                status = test_method.get('status', 'UNKNOWN')

                # Clean up test name - remove "test" prefix and make readable
                display_name = name.replace('test', '').replace('_', ' ').strip()
                if not display_name:
                    display_name = name

                # Determine status icon and color
                if status == 'PASS':
                    icon = '‚úÖ'
                    status_text = 'PASS'
                    row_class = 'pass'
                    status_color = '#4caf50'
                elif status == 'FAIL':
                    icon = '‚ùå'
                    status_text = 'FAIL'
                    row_class = 'fail'
                    status_color = '#f44336'
                else:
                    icon = '‚ö†Ô∏è'
                    status_text = 'SKIP'
                    row_class = 'skip'
                    status_color = '#ff9800'

                # Create table row
                row = f'''
                  <tr class="{row_class}">
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0;">{test_count}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">{html.escape(display_name)}</td>
                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #e0e0e0; color: {status_color}; font-weight: bold;">{icon} {status_text}</td>
                  </tr>'''
                test_rows.append(row)

            # Write to file
            with open('test_details.html', 'w', encoding='utf-8') as f:
                f.write('\n'.join(test_rows))

            print(f"Extracted {test_count} test results")

        except Exception as e:
            print(f"Error parsing test results: {e}")
            with open('test_details.html', 'w', encoding='utf-8') as f:
                f.write('<tr><td colspan="3" style="padding: 20px; text-align: center; color: #666;">No test details available</td></tr>')
        EOF

          echo "test_details_available=true" >> $GITHUB_OUTPUT
        else
          echo "TestNG results file not found"
          echo '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #666;">No test results found</td></tr>' > test_details.html
          echo "test_details_available=false" >> $GITHUB_OUTPUT
        fi

    - name: Find HTML Report
      if: always()
      id: find-report
      shell: bash
      run: |
        echo "üîç Looking for HTML test report..."

        # Find the most recent HTML report in simple-reports directory
        if [ -d "simple-reports" ]; then
          REPORT_FILE=$(ls -t simple-reports/AdHash_API_Simple_Report_*.html 2>/dev/null | head -n 1)
          if [ -n "$REPORT_FILE" ]; then
            echo "report_path=$REPORT_FILE" >> $GITHUB_OUTPUT
            echo "report_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found HTML report: $REPORT_FILE"

            # Get file size for logging
            FILE_SIZE=$(du -h "$REPORT_FILE" | cut -f1)
            echo "üìä Report size: $FILE_SIZE"
          else
            echo "report_found=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No HTML report found in simple-reports directory"
          fi
        else
          echo "report_found=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è simple-reports directory not found"
        fi

    - name: Check Email Secrets
      if: always()
      id: check-secrets
      run: |
        if [ -z "${{ secrets.EMAIL_USERNAME }}" ] || [ -z "${{ secrets.EMAIL_PASSWORD }}" ] || [ -z "${{ secrets.EMAIL_TO }}" ]; then
          echo "secrets_available=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Email secrets are not configured. Skipping email notifications."
          echo "Please add EMAIL_USERNAME, EMAIL_PASSWORD, and EMAIL_TO secrets to the repository."
        else
          echo "secrets_available=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Email secrets are configured."
        fi

    - name: Send Success Email
      if: always() && steps.test-results.outputs.status == 'SUCCESS' && steps.check-secrets.outputs.secrets_available == 'true'
      shell: bash
      run: |
        # Read test details
        TEST_DETAILS=$(cat test_details.html)

        # Create email body with test details injected
        cat > email_body_success.html << 'EMAILEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f5f5f5; padding: 20px; }
              .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .header { text-align: center; margin-bottom: 30px; }
              .title { color: #333; font-size: 28px; margin: 10px 0; }
              .subtitle { color: #666; font-size: 14px; }
              .stats-container { display: flex; justify-content: space-around; margin: 30px 0; flex-wrap: wrap; }
              .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; min-width: 150px; margin: 10px; }
              .stat-card.total { background: #e3f2fd; }
              .stat-card.passed { background: #e8f5e9; }
              .stat-card.failed { background: #ffebee; }
              .stat-number { font-size: 48px; font-weight: bold; margin: 10px 0; }
              .stat-label { font-size: 14px; color: #666; }
              .success-rate { text-align: center; margin: 30px 0; }
              .success-rate-number { font-size: 64px; font-weight: bold; color: #4caf50; }
              .success-rate-label { font-size: 16px; color: #666; }
              .status-banner { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin: 20px 0; }
              .info-box { background-color: #e7f3ff; padding: 15px; border-left: 4px solid #2196F3; margin: 20px 0; border-radius: 4px; }
              .projects-section { margin: 30px 0; }
              .project-table { width: 100%; border-collapse: separate; border-spacing: 8px; margin: 20px 0; }
              .project-item { background: #f8f9fa; padding: 12px 15px; border-radius: 6px; font-size: 14px; border: 1px solid #e0e0e0; }
              .test-details-section { margin: 30px 0; }
              .test-details-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
              .test-details-table th { background: #2196F3; color: white; padding: 12px; text-align: left; font-weight: bold; }
              .test-details-table tr.pass { background: #f1f8f4; }
              .test-details-table tr.fail { background: #fef1f1; }
              .test-details-table tr.skip { background: #fff8e1; }
              .test-details-table tr:hover { background: #f5f5f5; }
              .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1 class="title">üéØ AdHash API Test Report</h1>
                <p class="subtitle">${{ steps.test-results.outputs.timestamp }}</p>
              </div>

              <div class="stats-container">
                <div class="stat-card total">
                  <div class="stat-number" style="color: #1976d2;">${{ steps.test-results.outputs.tests_run }}</div>
                  <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-card passed">
                  <div class="stat-number" style="color: #4caf50;">‚úÖ ${{ steps.test-stats.outputs.passed }}</div>
                  <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card failed">
                  <div class="stat-number" style="color: #f44336;">‚ùå ${{ steps.test-stats.outputs.failed }}</div>
                  <div class="stat-label">Failed</div>
                </div>
              </div>

              <div class="success-rate">
                <div class="success-rate-number">${{ steps.test-stats.outputs.success_rate }}%</div>
                <div class="success-rate-label">Success Rate</div>
              </div>

              <div class="status-banner">
                ‚úÖ ALL TESTS PASSED
              </div>

              <div class="info-box">
                üìé <strong>Detailed HTML report is attached to this email.</strong><br>
                Open the attachment to view the complete test results with expandable test details.
              </div>

              <div class="test-details-section">
                <h3>üìã Individual API Test Results</h3>
                <table class="test-details-table">
                  <thead>
                    <tr>
                      <th style="width: 60px;">#</th>
                      <th>API Endpoint</th>
                      <th style="width: 120px; text-align: center;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    TEST_DETAILS_PLACEHOLDER
                  </tbody>
                </table>
              </div>

              <div class="projects-section">
                <h3>üöÄ AdHash Projects Tested</h3>
                <p>All <strong>73 API endpoints</strong> tested successfully across all AdHash projects:</p>
                <table class="project-table" cellpadding="5" cellspacing="0">
                  <tr>
                    <td class="project-item">üåê AdHash Website</td>
                    <td class="project-item">üîß AutoChecker (UI, Admin, App)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üè• MyHealth AI (Doctor SuperAdmin, Doctor Login)</td>
                    <td class="project-item">üíä KaiCare AI (Doctor SuperAdmin, Doctor Login)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üìã MHCRM (SuperAdmin, Admin)</td>
                    <td class="project-item">üè¢ MHCCM (SuperAdmin, CPA, PAR, Form, CRM)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üéØ MHRTM (SuperAdmin, CPA, Participant)</td>
                    <td class="project-item">üì± Patient Apps (MHAI, KCAI, Wavedin, Sparkme)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üåä WavedIn (SuperAdmin, Market Web)</td>
                    <td class="project-item">‚ú® Sparkme (Web Login)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üìà Algomax (ProSky, GoPocket)</td>
                    <td class="project-item">üéÆ LGM (Login UI, Phone, OTP)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üí¨ AskEPI (Login UI, Phone, OTP)</td>
                    <td class="project-item">üõ°Ô∏è RiskRealm (Admin, Chat, Login)</td>
                  </tr>
                  <tr>
                    <td class="project-item">üöó AutoeVantage (eCommerce, Tools, Analytics)</td>
                    <td class="project-item">üèõÔ∏è Metcalf</td>
                  </tr>
                  <tr>
                    <td class="project-item">üë• Humee (Admin, Dashboard, SuperAdmin, CPA, Participant)</td>
                    <td class="project-item">‚ö° ZAPAI</td>
                  </tr>
                </table>
              </div>

              <h3>üîó Useful Links</h3>
              <p>
                <a href="https://github.com/Thenilavan-G/AdHash-API-Test/actions" style="color: #2196F3; text-decoration: none;">View Workflow Run</a> |
                <a href="https://github.com/Thenilavan-G/AdHash-API-Test" style="color: #2196F3; text-decoration: none;">Repository</a>
              </p>

              <div class="footer">
                This is an automated message from AdHash Daily API Tests.<br>
                Scheduled runs: Daily at 9:00 AM IST and 5:00 PM IST
              </div>
            </div>
          </body>
          </html>
        EMAILEOF

        # Replace placeholder with actual test details
        python3 << 'PYEOF'
        import re

        # Read test details
        with open('test_details.html', 'r', encoding='utf-8') as f:
            test_details = f.read()

        # Read email template
        with open('email_body_success.html', 'r', encoding='utf-8') as f:
            email_body = f.read()

        # Replace placeholder
        email_body = email_body.replace('TEST_DETAILS_PLACEHOLDER', test_details)

        # Write final email
        with open('email_body_success_final.html', 'w', encoding='utf-8') as f:
            f.write(email_body)
        PYEOF

        # Send email using Python SMTP
        python3 << 'PYEOF'
        import smtplib
        from email.mime.multipart import MIMEMultipart
        from email.mime.text import MIMEText
        from email.mime.base import MIMEBase
        from email import encoders
        import os

        # Email configuration
        smtp_server = "smtp.zoho.com"
        smtp_port = 465
        username = "${{ secrets.EMAIL_USERNAME }}"
        password = "${{ secrets.EMAIL_PASSWORD }}"
        from_email = "${{ secrets.EMAIL_USERNAME }}"
        to_email = "${{ secrets.EMAIL_TO }}"
        subject = "‚úÖ AdHash Daily API Tests - SUCCESS (${{ steps.test-results.outputs.timestamp }})"

        # Read email body
        with open('email_body_success_final.html', 'r', encoding='utf-8') as f:
            html_body = f.read()

        # Create message
        msg = MIMEMultipart()
        msg['From'] = from_email
        msg['To'] = to_email
        msg['Subject'] = subject

        # Attach HTML body
        msg.attach(MIMEText(html_body, 'html'))

        # Attach HTML report if available
        report_path = "${{ steps.find-report.outputs.report_path }}"
        if report_path and os.path.exists(report_path):
            with open(report_path, 'rb') as f:
                part = MIMEBase('application', 'octet-stream')
                part.set_payload(f.read())
                encoders.encode_base64(part)
                part.add_header('Content-Disposition', f'attachment; filename="{os.path.basename(report_path)}"')
                msg.attach(part)

        # Send email
        try:
            with smtplib.SMTP_SSL(smtp_server, smtp_port) as server:
                server.login(username, password)
                server.send_message(msg)
            print("Success email sent successfully!")
        except Exception as e:
            print(f"Error sending email: {e}")
            raise
        PYEOF

    - name: Send Failure Email
      if: always() && (steps.test-results.outputs.status == 'FAILURE' || steps.test-results.outputs.status == 'NO_TESTS') && steps.check-secrets.outputs.secrets_available == 'true'
      shell: bash
      run: |
        # Read test details
        TEST_DETAILS=$(cat test_details.html)

        # Create email body with test details injected
        cat > email_body_failure.html << 'EMAILEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f5f5f5; padding: 20px; }
              .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .header { text-align: center; margin-bottom: 30px; }
              .title { color: #333; font-size: 28px; margin: 10px 0; }
              .subtitle { color: #666; font-size: 14px; }
              .stats-container { display: flex; justify-content: space-around; margin: 30px 0; flex-wrap: wrap; }
              .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; min-width: 150px; margin: 10px; }
              .stat-card.total { background: #e3f2fd; }
              .stat-card.passed { background: #e8f5e9; }
              .stat-card.failed { background: #ffebee; }
              .stat-number { font-size: 48px; font-weight: bold; margin: 10px 0; }
              .stat-label { font-size: 14px; color: #666; }
              .success-rate { text-align: center; margin: 30px 0; }
              .success-rate-number { font-size: 64px; font-weight: bold; }
              .success-rate-label { font-size: 16px; color: #666; }
              .status-banner { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin: 20px 0; }
              .status-banner.failed { background: #f8d7da; color: #721c24; }
              .warning-box { background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; border-radius: 4px; }
              .troubleshooting { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
              .test-details-section { margin: 30px 0; }
              .test-details-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
              .test-details-table th { background: #2196F3; color: white; padding: 12px; text-align: left; font-weight: bold; }
              .test-details-table tr.pass { background: #f1f8f4; }
              .test-details-table tr.fail { background: #fef1f1; }
              .test-details-table tr.skip { background: #fff8e1; }
              .test-details-table tr:hover { background: #f5f5f5; }
              .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1 class="title">üéØ AdHash API Test Report</h1>
                <p class="subtitle">${{ steps.test-results.outputs.timestamp }}</p>
              </div>

              <div class="stats-container">
                <div class="stat-card total">
                  <div class="stat-number" style="color: #1976d2;">${{ steps.test-results.outputs.tests_run }}</div>
                  <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-card passed">
                  <div class="stat-number" style="color: #4caf50;">‚úÖ ${{ steps.test-stats.outputs.passed }}</div>
                  <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card failed">
                  <div class="stat-number" style="color: #f44336;">‚ùå ${{ steps.test-stats.outputs.failed }}</div>
                  <div class="stat-label">Failed</div>
                </div>
              </div>

              <div class="success-rate">
                <div class="success-rate-number" style="color: #f44336;">
                  ${{ steps.test-stats.outputs.success_rate }}%
                </div>
                <div class="success-rate-label">Success Rate</div>
              </div>

              <div class="status-banner failed">
                ‚ùå TESTS FAILED
              </div>

              <div class="warning-box">
                üìé <strong>Detailed HTML report is attached to this email.</strong><br>
                Open the attachment to view the complete test results and identify which tests failed.
              </div>

              <div class="test-details-section">
                <h3>üìã Individual API Test Results</h3>
                <table class="test-details-table">
                  <thead>
                    <tr>
                      <th style="width: 60px;">#</th>
                      <th>API Endpoint</th>
                      <th style="width: 120px; text-align: center;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    TEST_DETAILS_PLACEHOLDER
                  </tbody>
                </table>
              </div>

              <div class="troubleshooting">
                <h3>üîç Troubleshooting Steps</h3>
                <ol>
                  <li><strong>Check API Endpoints:</strong> Verify all AdHash project APIs are accessible</li>
                  <li><strong>Authentication:</strong> Check if login credentials are valid</li>
                  <li><strong>Network Issues:</strong> Check for any network connectivity problems</li>
                  <li><strong>Server Status:</strong> Ensure all AdHash project servers are running</li>
                  <li><strong>Review Logs:</strong> Check GitHub Actions logs for detailed error messages</li>
                </ol>
              </div>

              <h3>üîó Investigation Links</h3>
              <p>
                <a href="https://github.com/Thenilavan-G/AdHash-API-Test/actions" style="color: #2196F3; text-decoration: none;">View Workflow Run</a> |
                <a href="https://github.com/Thenilavan-G/AdHash-API-Test" style="color: #2196F3; text-decoration: none;">Repository</a>
              </p>

              <div class="footer">
                This is an automated message from AdHash Daily API Tests.<br>
                Scheduled runs: Daily at 9:00 AM IST and 5:00 PM IST. Please investigate and resolve any issues promptly.
              </div>
            </div>
          </body>
          </html>
        EMAILEOF

        # Replace placeholder with actual test details
        python3 << 'PYEOF'
        import re

        # Read test details
        with open('test_details.html', 'r', encoding='utf-8') as f:
            test_details = f.read()

        # Read email template
        with open('email_body_failure.html', 'r', encoding='utf-8') as f:
            email_body = f.read()

        # Replace placeholder
        email_body = email_body.replace('TEST_DETAILS_PLACEHOLDER', test_details)

        # Write final email
        with open('email_body_failure_final.html', 'w', encoding='utf-8') as f:
            f.write(email_body)
        PYEOF

        # Send email using Python SMTP
        python3 << 'PYEOF'
        import smtplib
        from email.mime.multipart import MIMEMultipart
        from email.mime.text import MIMEText
        from email.mime.base import MIMEBase
        from email import encoders
        import os

        # Email configuration
        smtp_server = "smtp.zoho.com"
        smtp_port = 465
        username = "${{ secrets.EMAIL_USERNAME }}"
        password = "${{ secrets.EMAIL_PASSWORD }}"
        from_email = "${{ secrets.EMAIL_USERNAME }}"
        to_email = "${{ secrets.EMAIL_TO }}"
        subject = "‚ùå AdHash Daily API Tests - FAILED (${{ steps.test-results.outputs.timestamp }})"

        # Read email body
        with open('email_body_failure_final.html', 'r', encoding='utf-8') as f:
            html_body = f.read()

        # Create message
        msg = MIMEMultipart()
        msg['From'] = from_email
        msg['To'] = to_email
        msg['Subject'] = subject

        # Attach HTML body
        msg.attach(MIMEText(html_body, 'html'))

        # Attach HTML report if available
        report_path = "${{ steps.find-report.outputs.report_path }}"
        if report_path and os.path.exists(report_path):
            with open(report_path, 'rb') as f:
                part = MIMEBase('application', 'octet-stream')
                part.set_payload(f.read())
                encoders.encode_base64(part)
                part.add_header('Content-Disposition', f'attachment; filename="{os.path.basename(report_path)}"')
                msg.attach(part)

        # Send email
        try:
            with smtplib.SMTP_SSL(smtp_server, smtp_port) as server:
                server.login(username, password)
                server.send_message(msg)
            print("Failure email sent successfully!")
        except Exception as e:
            print(f"Error sending email: {e}")
            raise
        PYEOF

    - name: Warn about missing secrets
      if: always() && steps.check-secrets.outputs.secrets_available == 'false'
      run: |
        echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è WARNING: Email secrets are not configured! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
        echo ""
        echo "To receive email notifications, please add these secrets to the repository:"
        echo "1. Go to: https://github.com/Thenilavan-G/AdHash-API-Test/settings/secrets/actions"
        echo "2. Add the following secrets:"
        echo "   - EMAIL_USERNAME: Your Zoho email address"
        echo "   - EMAIL_PASSWORD: Your Zoho email password"
        echo "   - EMAIL_TO: Recipient email address"
        echo ""
        echo "Without these secrets, the workflow will run but won't send email notifications."

    - name: Notify on failure (Console)
      if: failure()
      run: |
        echo "‚ùå AdHash API Tests workflow failed!"
        echo "Please check the logs above for details."

