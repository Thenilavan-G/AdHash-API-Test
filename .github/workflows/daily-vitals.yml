name: Daily Vitals Test Automation

on:
  schedule:
    # Runs daily at 10:00 AM IST (4:30 AM UTC)
    - cron: '30 4 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  run-vitals-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Display current IST time
      run: |
        echo "Current UTC time: $(date -u)"
        echo "Current IST time: $(TZ='Asia/Kolkata' date)"
        
    - name: Create test data directory
      run: mkdir -p data
      
    - name: Create minimal Excel file for mobile numbers
      run: |
        # Create a simple CSV file that can be converted to Excel format
        # This contains minimal data needed for mobile numbers
        cat > data/test_data.csv << 'EOF'
        FirstName,LastName,PatientID,DOB,Gender,MobileNumber,Email,HRDate,BPDate,OxyDate,BGDate,BGCurrentDate
        TestUser,One,PAT001,01/01/1990,M,9876543210,test1@example.com,,,,,
        TestUser,Two,PAT002,01/01/1985,F,9876543211,test2@example.com,,,,,
        EOF
        
    - name: Install Python and dependencies for Excel conversion
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl
        
    - name: Convert CSV to Excel
      run: |
        python << 'EOF'
        import pandas as pd
        
        # Read CSV and convert to Excel
        df = pd.read_csv('data/test_data.csv')
        df.to_excel('data/Test_data.xlsx', sheet_name='AddPatient', index=False)
        print("Excel file created successfully")
        EOF
        
    - name: Verify Excel file
      run: |
        ls -la data/
        python << 'EOF'
        import pandas as pd
        df = pd.read_excel('data/Test_data.xlsx', sheet_name='AddPatient')
        print("Excel file contents:")
        print(df.head())
        print(f"Shape: {df.shape}")
        EOF
        
    - name: Run Maven tests
      run: |
        # Run the AddVitals test using TestNG suite
        mvn test -DsuiteXmlFile=vitals-testng.xml -DfailIfNoTests=false
        
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/test-classes/
          
    - name: Send notification on failure
      if: failure()
      run: |
        echo "Test execution failed at IST time: $(TZ='Asia/Kolkata' date)"
        echo "Check the test results artifact for details"
