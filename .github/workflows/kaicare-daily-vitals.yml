name: KaiCare Daily Vitals Automation

on:
  schedule:
    # Runs daily at 6:00 AM IST (12:30 AM UTC)
    - cron: '30 0 * * *'
  workflow_dispatch:
    # Allows manual triggering of the workflow
  push:
    branches: [ master ]

jobs:
  vitals-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Create test data files
      run: |
        echo "Creating required test data files..."
        mkdir -p data
        touch data/placeholder.txt
        echo "Test data files created successfully"
        
    - name: Display current IST time
      run: |
        echo "Current UTC time: $(date -u)"
        echo "Current IST time: $(TZ='Asia/Kolkata' date)"
        echo "Workflow triggered for daily vitals automation"
        
    - name: Run KaiCare Vitals Tests
      run: |
        echo "Starting KaiCare Daily Vitals Automation..."
        echo "Running all 11 test methods for complete vitals data insertion"
        mvn test -Dsurefire.suiteXmlFiles=TestNG.xml -DfailIfNoTests=false
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: kaicare-vitals-test-results
        path: |
          target/surefire-reports/
          target/test-classes/
        retention-days: 30
        
    - name: Display test summary
      if: always()
      run: |
        echo "=== KaiCare Vitals Automation Summary ==="
        echo "Date: $(TZ='Asia/Kolkata' date '+%d/%m/%Y %H:%M IST')"
        echo "Repository: KaiCare_Vitals_API"
        echo "Test Suite: TestNG.xml"
        echo "Expected Tests: 11 (Login + HR + BP + Oxygen + Blood Glucose)"
        echo "Data Insertion: Current IST date with 6:00 AM common time"
        echo "Mobile Numbers: 11 numbers from Excel (9999999996, 9000000001-9000000008, 9898989800, 5159490885)"
        echo "============================================="
        
        if [ -f target/surefire-reports/testng-results.xml ]; then
          echo "Test results found - checking status..."
        else
          echo "Test results file not found"
        fi
        
    - name: Parse test results
      if: always()
      id: test-results
      run: |
        # Initialize variables
        TESTS_RUN=0
        FAILURES=0
        ERRORS=0
        SKIPPED=0
        STATUS="UNKNOWN"

        # Parse TestNG results if available
        if [ -f target/surefire-reports/testng-results.xml ]; then
          echo "Parsing TestNG results..."
          TESTS_RUN=$(grep -o 'total="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
          FAILURES=$(grep -o 'failed="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
          ERRORS=$(grep -o 'errors="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
          SKIPPED=$(grep -o 'skipped="[0-9]*"' target/surefire-reports/testng-results.xml | grep -o '[0-9]*' || echo "0")
        fi

        # Determine overall status
        if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ] && [ "$TESTS_RUN" -gt 0 ]; then
          STATUS="SUCCESS"
        elif [ "$TESTS_RUN" -eq 0 ]; then
          STATUS="NO_TESTS"
        else
          STATUS="FAILURE"
        fi

        # Set outputs for email step
        echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
        echo "failures=$FAILURES" >> $GITHUB_OUTPUT
        echo "errors=$ERRORS" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "timestamp=$(TZ='Asia/Kolkata' date '+%d/%m/%Y %H:%M IST')" >> $GITHUB_OUTPUT
        echo "insertion_date=$(TZ='Asia/Kolkata' date '+%d/%m/%Y')" >> $GITHUB_OUTPUT

        echo "Test Results Summary:"
        echo "Tests Run: $TESTS_RUN"
        echo "Failures: $FAILURES"
        echo "Errors: $ERRORS"
        echo "Skipped: $SKIPPED"
        echo "Status: $STATUS"

    - name: Debug Email Configuration
      if: always()
      run: |
        echo "=== Email Configuration Debug ==="
        echo "EMAIL_USERNAME is set: ${{ secrets.EMAIL_USERNAME != '' }}"
        echo "EMAIL_PASSWORD is set: ${{ secrets.EMAIL_PASSWORD != '' }}"
        echo "EMAIL_TO is set: ${{ secrets.EMAIL_TO != '' }}"
        echo "Test Status: ${{ steps.test-results.outputs.status }}"
        echo "Timestamp: ${{ steps.test-results.outputs.timestamp }}"
        echo "================================="



    - name: Send Success Email
      if: always() && steps.test-results.outputs.status == 'SUCCESS'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.zoho.com
        server_port: 465
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚úÖ KaiCare Daily Vitals Automation - SUCCESS (${{ steps.test-results.outputs.timestamp }})"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        ignore_cert: true
        convert_markdown: true
        html_body: |
          <h2 style="color: #28a745;">‚úÖ KaiCare Daily Vitals Automation - SUCCESS</h2>

          <h3>üìä Test Results Summary</h3>
          <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr style="background-color: #f8f9fa;">
              <td><strong>Execution Time</strong></td>
              <td>${{ steps.test-results.outputs.timestamp }}</td>
            </tr>
            <tr>
              <td><strong>Tests Run</strong></td>
              <td style="color: #28a745;">${{ steps.test-results.outputs.tests_run }}</td>
            </tr>
            <tr>
              <td><strong>Failures</strong></td>
              <td>${{ steps.test-results.outputs.failures }}</td>
            </tr>
            <tr>
              <td><strong>Errors</strong></td>
              <td>${{ steps.test-results.outputs.errors }}</td>
            </tr>
            <tr>
              <td><strong>Skipped</strong></td>
              <td>${{ steps.test-results.outputs.skipped }}</td>
            </tr>
            <tr style="background-color: #d4edda;">
              <td><strong>Overall Status</strong></td>
              <td style="color: #155724; font-weight: bold;">SUCCESS ‚úÖ</td>
            </tr>
          </table>

          <h3>üì± Mobile Numbers Tested</h3>
          <p>Successfully tested <strong>11 mobile numbers</strong> from Excel file:</p>
          <ul>
            <li>9999999996</li>
            <li>9000000001 - 9000000008 (8 numbers)</li>
            <li>9898989800</li>
            <li>5159490885</li>
          </ul>

          <h3>üíâ Vitals Data Inserted</h3>
          <p>All vital types successfully inserted with timestamp: <strong>${{ steps.test-results.outputs.insertion_date }} at 6:00 AM IST</strong></p>
          <ul>
            <li>‚ù§Ô∏è Heart Rate (2 values per mobile number)</li>
            <li>ü©∏ Blood Pressure (2 values per mobile number)</li>
            <li>ü´Å Oxygen Saturation (2 values per mobile number)</li>
            <li>üçØ Blood Glucose (2 values per mobile number)</li>
          </ul>

          <h3>üîó Links</h3>
          <p>
            <a href="https://github.com/Thenilavan-G/KaiCare_Vitals_API/actions">View GitHub Actions</a> |
            <a href="https://github.com/Thenilavan-G/KaiCare_Vitals_API">Repository</a>
          </p>

          <hr>
          <p style="color: #6c757d; font-size: 12px;">
            This is an automated message from KaiCare Daily Vitals Automation.<br>
            Next scheduled run: Tomorrow at 6:00 AM IST
          </p>

    - name: Send Failure Email
      if: always() && (steps.test-results.outputs.status == 'FAILURE' || steps.test-results.outputs.status == 'NO_TESTS')
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.zoho.com
        server_port: 465
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚ùå KaiCare Daily Vitals Automation - FAILED (${{ steps.test-results.outputs.timestamp }})"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_USERNAME }}
        ignore_cert: true
        convert_markdown: true
        html_body: |
          <h2 style="color: #dc3545;">‚ùå KaiCare Daily Vitals Automation - FAILED</h2>

          <h3>üìä Test Results Summary</h3>
          <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr style="background-color: #f8f9fa;">
              <td><strong>Execution Time</strong></td>
              <td>${{ steps.test-results.outputs.timestamp }}</td>
            </tr>
            <tr>
              <td><strong>Tests Run</strong></td>
              <td>${{ steps.test-results.outputs.tests_run }}</td>
            </tr>
            <tr style="background-color: #f8d7da;">
              <td><strong>Failures</strong></td>
              <td style="color: #721c24; font-weight: bold;">${{ steps.test-results.outputs.failures }}</td>
            </tr>
            <tr style="background-color: #f8d7da;">
              <td><strong>Errors</strong></td>
              <td style="color: #721c24; font-weight: bold;">${{ steps.test-results.outputs.errors }}</td>
            </tr>
            <tr>
              <td><strong>Skipped</strong></td>
              <td>${{ steps.test-results.outputs.skipped }}</td>
            </tr>
            <tr style="background-color: #f5c6cb;">
              <td><strong>Overall Status</strong></td>
              <td style="color: #721c24; font-weight: bold;">FAILED ‚ùå</td>
            </tr>
          </table>

          <h3>üîç Troubleshooting Steps</h3>
          <ol>
            <li><strong>Check API Connectivity:</strong> Verify KaiCare API endpoints are accessible</li>
            <li><strong>Mobile Number Status:</strong> Ensure all mobile numbers are enrolled with doctors</li>
            <li><strong>Authentication:</strong> Check if access tokens are being generated correctly</li>
            <li><strong>Excel File:</strong> Verify Test_data.xlsx is accessible and contains valid data</li>
            <li><strong>Network Issues:</strong> Check for any network connectivity problems</li>
            <li><strong>Time Validation:</strong> Ensure timestamp (${{ steps.test-results.outputs.insertion_date }} at 6:00 AM IST) falls within acceptable time windows</li>
          </ol>

          <h3>üì± Expected Mobile Numbers</h3>
          <p>Should test <strong>11 mobile numbers</strong> from Excel file:</p>
          <ul>
            <li>9999999996, 9000000001-9000000008, 9898989800, 5159490885</li>
          </ul>

          <h3>üîó Investigation Links</h3>
          <p>
            <a href="https://github.com/Thenilavan-G/KaiCare_Vitals_API/actions">View Failed Run Details</a> |
            <a href="https://github.com/Thenilavan-G/KaiCare_Vitals_API">Repository</a>
          </p>

          <hr>
          <p style="color: #6c757d; font-size: 12px;">
            This is an automated message from KaiCare Daily Vitals Automation.<br>
            Please investigate and resolve the issue before the next scheduled run at 6:00 AM IST tomorrow.
          </p>

    - name: Notify on failure (Console)
      if: failure()
      run: |
        echo "‚ùå KaiCare Vitals Automation Failed!"
        echo "Email notification sent with detailed failure information."
        echo "Please check your email and the GitHub Actions logs for details."
